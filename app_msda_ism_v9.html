<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Evaluador MSDA/TERC + ISM — v9 (literal)</title>
<link rel="stylesheet" href="styles_v9.css">
</head>
<body>
<header>
  <h1>Evaluador MSDA/TERC + ISM — v9</h1>
  <p class="muted">Transcripción literal de tablas y denominaciones. Ingrese valores (0–100) para C1–C21 y para ISM (Equidad, Diversidad, Resonancia).</p>
</header>

<main>
  <section class="card">
    <div class="row">
      <label class="lbl">Proyecto</label>
      <input id="projName" class="field" placeholder="Nombre del proyecto">
      <button id="demoBtn" class="btn">Cargar DEMO</button>
      <input id="csvFile" type="file" accept=".csv" style="display:none">
      <button id="csvBtn" class="btn ghost">Cargar CSV (plantilla)</button>
      <button id="goCalc" class="btn">Calcular + Dibujar</button>
      <button id="goJPG" class="btn">Exportar JPEG (alta)</button>
    </div>
    <p id="csvStatus" class="small muted"></p>
  </section>

  <section class="card">
    <h2>Entradas — C1..C21 + ISM (0–100)</h2>
    <div class="grid">
      <div>
        <h3>Asimilación (Recepción de información)</h3>
        <label>C1 Carga Informativa del Espacio <input type="number" id="C1" min="0" max="100" class="num"></label>
        <label>C2 Diversidad Perceptual <input type="number" id="C2" min="0" max="100" class="num"></label>
        <label>C3 Conectividad Sensorial <input type="number" id="C3" min="0" max="100" class="num"></label>
        <label>C4 Accesibilidad Cognitiva <input type="number" id="C4" min="0" max="100" class="num"></label>
        <h3>Acomodación (Transformación Cognitiva del Usuario)</h3>
        <label>C5 Plasticidad Ambiental <input type="number" id="C5" min="0" max="100" class="num"></label>
        <label>C6 Complejidad Estructural vs. Legibilidad <input type="number" id="C6" min="0" max="100" class="num"></label>
        <label>C7 Efecto de Resonancia Cognitiva <input type="number" id="C7" min="0" max="100" class="num"></label>
        <label>C8 Interacción Natural o Biofílica <input type="number" id="C8" min="0" max="100" class="num"></label>
      </div>
      <div>
        <h3>Indicadores de Equilibrio Adaptativo (Respuesta Cognitiva y Conductual)</h3>
        <label>C9 Engagement Espacial <input type="number" id="C9" min="0" max="100" class="num"></label>
        <label>C10 Fluidez en la Navegación Espacial <input type="number" id="C10" min="0" max="100" class="num"></label>
        <label>C11 Efecto Memorístico <input type="number" id="C11" min="0" max="100" class="num"></label>
        <label>C12 Resonancia Emocional <input type="number" id="C12" min="0" max="100" class="num"></label>
        <h3>Indicadores Biomiméticos (Bioestructural)</h3>
        <label>C13 Eficiencia Geométrica <input type="number" id="C13" min="0" max="100" class="num"></label>
        <label>C14 Optimización Estructural <input type="number" id="C14" min="0" max="100" class="num"></label>
        <label>C15 Uso de Biomateriales <input type="number" id="C15" min="0" max="100" class="num"></label>
      </div>
      <div>
        <h3>Biomímesis (Biofísica) y Ecosistémica</h3>
        <label>C16 Eficiencia Energética <input type="number" id="C16" min="0" max="100" class="num"></label>
        <label>C17 Adaptabilidad Térmica <input type="number" id="C17" min="0" max="100" class="num"></label>
        <label>C18 Captación y Uso de Agua <input type="number" id="C18" min="0" max="100" class="num"></label>
        <label>C19 Integración con la Naturaleza <input type="number" id="C19" min="0" max="100" class="num"></label>
        <label>C20 Ciclo de Materiales <input type="number" id="C20" min="0" max="100" class="num"></label>
        <label>C21 Bienestar Biofílico <input type="number" id="C21" min="0" max="100" class="num"></label>
        <h3>Índice Social Medible (ISM)</h3>
        <label>Equidad de acceso <input type="number" id="EQ" min="0" max="100" class="num"></label>
        <label>Diversidad de usos y actores <input type="number" id="DIV" min="0" max="100" class="num"></label>
        <label>Resonancia comunitaria <input type="number" id="RES" min="0" max="100" class="num"></label>
      </div>
    </div>
    <p class="small">CSV: columnas = Proyecto,C1..C21,Equidad,Diversidad,Resonancia (primera fila de datos).</p>
  </section>

  <section class="card">
    <h2>Radar MSDA/TERC (6) + Triángulo ISM (3)</h2>
    <canvas id="radar" width="1100" height="1100"></canvas>
  </section>

  <section class="card">
    <h2>Calificación por característica (C1…C21)</h2>
    <canvas id="bars" width="1300" height="1100"></canvas>
  </section>

  <section class="card">
    <h2>RESULTADOS DE MEDICIÓN COGNITIVA</h2>
    <div class="row">
      <div class="placa">
        <h4>Escala de Valoración Compuesta (EVC – TERC)</h4>
        <div id="placaEVC" class="valor">—</div>
      </div>
      <div class="placa">
        <h4>Índice Social Medible (ISM)</h4>
        <div id="placaISM" class="valor">—</div>
      </div>
    </div>
    <pre id="resultadoTxt" class="mono" style="margin-top:12px"></pre>
  </section>

  <section class="card">
    <h2>Transcripción literal de definiciones</h2>

    <h3>Indicadores de Asimilación (Recepción de Información).</h3>
    <table>
      <thead><tr><th>Categoría</th><th>Código</th><th>Característica</th><th>Descripción</th></tr></thead>
      <tbody>
        <tr><td>Indicadores de Asimilación (Recepción de Información)</td><td>C1</td><td>Carga Informativa del Espacio</td><td>Densidad informativa basada en patrones, texturas y materiales para estimular la cognición.</td></tr>
        <tr><td>Indicadores de Asimilación (Recepción de Información)</td><td>C2</td><td>Diversidad Perceptual</td><td>Capacidad de activar distintos canales sensoriales (visual, háptico, auditivo, olfativo), mejorando la asimilación de información.</td></tr>
        <tr><td>Indicadores de Asimilación (Recepción de Información)</td><td>C3</td><td>Conectividad Sensorial</td><td>Interacción entre la organización espacial y los sistemas sensoriales para mejorar la percepción y la experiencia del usuario.</td></tr>
        <tr><td>Indicadores de Asimilación (Recepción de Información)</td><td>C4</td><td>Accesibilidad Cognitiva</td><td>Diseño que optimiza la facilidad de interpretación y navegación en el entorno, guiando la atención hacia puntos estratégicos.</td></tr>
      </tbody>
    </table>

    <h3>Indicadores de Acomodación (Transformación Cognitiva del Usuario).</h3>
    <table>
      <thead><tr><th>Categoría</th><th>Código</th><th>Característica</th><th>Descripción</th></tr></thead>
      <tbody>
        <tr><td>Indicadores de Acomodación</td><td>C5</td><td>Plasticidad Ambiental</td><td>Capacidad del espacio para adaptarse a necesidades cambiantes del usuario, promoviendo interacción flexible con el entorno.</td></tr>
        <tr><td>Indicadores de Acomodación</td><td>C6</td><td>Complejidad Estructural vs. Legibilidad</td><td>Equilibrio entre complejidad estructural y facilidad de interpretación mediante geometría fractal.</td></tr>
        <tr><td>Indicadores de Acomodación</td><td>C7</td><td>Efecto de Resonancia Cognitiva</td><td>Impacto del diseño en la memoria y respuesta emocional del usuario, facilitando evocación y refuerzo de experiencias.</td></tr>
        <tr><td>Indicadores de Acomodación</td><td>C8</td><td>Interacción Natural o Biofílica</td><td>Diseño que fomenta interacciones fluidas con elementos naturales, promoviendo una experiencia integrada con el entorno.</td></tr>
      </tbody>
    </table>

    <h3>Indicadores de Equilibrio Adaptativo (Respuesta Cognitiva y Conductual).</h3>
    <table>
      <thead><tr><th>Categoría</th><th>Código</th><th>Característica</th><th>Descripción</th></tr></thead>
      <tbody>
        <tr><td>Indicadores de Equilibrio Adaptativo</td><td>C9</td><td>Engagement Espacial</td><td>Incentiva la participación activa del usuario en su entorno, promoviendo inmersión y apropiación del espacio.</td></tr>
        <tr><td>Indicadores de Equilibrio Adaptativo</td><td>C10</td><td>Fluidez en la Navegación Espacial</td><td>Facilita la orientación y desplazamiento mediante referencias espaciales claras y principios de wayfinding naturales.</td></tr>
        <tr><td>Indicadores de Equilibrio Adaptativo</td><td>C11</td><td>Efecto Memorístico</td><td>Diseño de anclajes cognitivos que refuercen la continuidad perceptiva del espacio, favoreciendo la familiarización progresiva.</td></tr>
        <tr><td>Indicadores de Equilibrio Adaptativo</td><td>C12</td><td>Resonancia Emocional</td><td>Influencia del diseño en la respuesta afectiva del usuario, generando bienestar y conexión psicológica con el espacio.</td></tr>
      </tbody>
    </table>

    <h3>Indicadores de Formas Naturales (IFN).</h3>
    <table>
      <thead><tr><th>Categoría</th><th>Código</th><th>Característica</th><th>Descripción</th></tr></thead>
      <tbody>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C13</td><td>Eficiencia Geométrica</td><td>Uso de patrones geométricos naturales para optimizar distribución de cargas y mejorar la estructura.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C14</td><td>Optimización Estructural</td><td>Aplicación de principios biomecánicos en la arquitectura para mejorar resistencia y flexibilidad.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C15</td><td>Uso de Biomateriales</td><td>Incorporación de materiales biodegradables y sostenibles para promover un ciclo de vida circular.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C16</td><td>Eficiencia Energética</td><td>Uso de estrategias bioclimáticas naturales para iluminación y ventilación, reduciendo el consumo energético.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C17</td><td>Adaptabilidad Térmica</td><td>Implementación de sistemas inspirados en organismos biológicos para regulación térmica pasiva.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C18</td><td>Captación y Uso de Agua</td><td>Sistemas biomiméticos para la recolección, filtración y reutilización del agua replicando procesos naturales.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C19</td><td>Integración con la Naturaleza</td><td>Diseño estratégico para la conexión armónica entre el entorno construido y el ecosistema circundante.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C20</td><td>Ciclo de Materiales</td><td>Aplicación de principios de economía circular en la reutilización y reciclaje de materiales de construcción.</td></tr>
        <tr><td>Indicadores de Formas Naturales (IFN)</td><td>C21</td><td>Bienestar Biofílico</td><td>Regulación sensorial y fisiológica del usuario mediante integración de luz natural, vegetación y variaciones térmicas en el diseño.</td></tr>
      </tbody>
    </table>

    <!-- NUEVA TABLA: ISM Características (antes de la métrica ISM) -->
    <h3>Índice Social Medible (ISM) – Características</h3>
    <table>
      <thead><tr><th>Característica</th><th>Descripción</th></tr></thead>
      <tbody>
        <tr><td>Equidad de acceso</td><td>Mide la accesibilidad física, económica y cultural al proyecto.</td></tr>
        <tr><td>Diversidad de usos y actores</td><td>Mide la capacidad del espacio para albergar múltiples actividades y grupos sociales.</td></tr>
        <tr><td>Resonancia comunitaria</td><td>Evalúa si el espacio potencia interacción dialógica y memoria colectiva.</td></tr>
      </tbody>
    </table>

    <h3>Métrica para el ISM</h3>
    <table>
      <thead><tr><th>Rango ISM (%)</th><th>Nivel</th><th>Caracterización cualitativa</th></tr></thead>
      <tbody>
        <tr><td>80–100</td><td>Muy Alto</td><td>Espacios con alta equidad de acceso, gran diversidad de actores y fuerte resonancia comunitaria. Generan cohesión social y apropiación colectiva.</td></tr>
        <tr><td>70–79</td><td>Alto</td><td>Espacios con buen acceso y diversidad de usos, pero con limitaciones parciales en participación o apropiación comunitaria. Favorecen inclusión, aunque de manera desigual.</td></tr>
        <tr><td>60–69</td><td>Medio</td><td>Espacios socialmente funcionales pero no integradores. La diversidad o la resonancia quedan restringidas a ciertos grupos; equidad parcial.</td></tr>
        <tr><td>50–59</td><td>Bajo</td><td>Espacios con acceso restringido y baja diversidad. La resonancia comunitaria es débil; predominan usos excluyentes o elitistas.</td></tr>
        <tr><td>&lt;50</td><td>Muy Bajo</td><td>Espacios excluyentes y socialmente pobres: equidad mínima, sin diversidad de actores, sin memoria ni apropiación comunitaria. Generan segregación social.</td></tr>
      </tbody>
    </table>

    <h3>Escala de Valoración Compuesta (EVC – TERC)</h3>
    <table>
      <thead><tr><th>Rango %</th><th>Nivel</th><th>Escala de Valoración Compuesta (EVC – TERC).</th></tr></thead>
      <tbody>
        <tr><td>80–100</td><td>Muy Alto</td><td>Espacios legibles, inmersivos, biofílicos, biomiméticos y memorables; máxima cognición adaptativa con el sujeto. Proyectos que integran armónicamente los tres espacios de la TERC. Se caracterizan por asimilación clara de información, adaptabilidad espacial, inmersión memorística y un fuerte grado de biofilia y simbiosis ecosistémica.</td></tr>
        <tr><td>70–79</td><td>Alto</td><td>Proyectos equilibrados en función y efectivos en su organización espacial, con limitaciones parciales en alguna dimensión. Proyectos equilibrados que logran un buen desempeño en la mayoría de los índices, aunque muestran limitaciones puntuales.</td></tr>
        <tr><td>60–69</td><td>Medio</td><td>Espacios funcionales, impacto cognitivo fragmentario o inconsistente.  Proyectos funcionales, pero con desbalances internos: algún índice (IAE, IAB o ICE) se desploma y arrastra el promedio, reflejando que la cognición adaptativa no se consolida en todas sus fases.</td></tr>
        <tr><td>&lt;60</td><td>Bajo</td><td>Resonancia cognitiva deficiente; predominio de lo utilitario sobre lo simbiótico. Proyectos donde la asimilación y resonancia están debilitadas y la arquitectura no logra operar como organismo cognitivo-simbiótico. El espacio funciona, pero no estimula ni genera memorabilidad significativa.</td></tr>
      </tbody>
    </table>

    <!-- Se elimina la lista <ul> redundante del ISM para evitar duplicidad -->
  </section>
</main>

<script>
const g=id=>document.getElementById(id);
const nv=id=>{const x=parseFloat(g(id).value);return isNaN(x)?null:x};
const prom=a=>{const f=a.filter(v=>v!=null);return f.length?f.reduce((s,v)=>s+v,0)/f.length:null};

function calcAll(){
  const v = {};
  for(let i=1;i<=21;i++) v['C'+i]=nv('C'+i);
  const IPC=prom([v.C1,v.C2,v.C3,v.C4]);
  const IAE=prom([v.C5,v.C6,v.C7,v.C8]);
  const IIM=prom([v.C9,v.C10,v.C11,v.C12]);
  const IEB=prom([v.C13,v.C14,v.C15]);
  const IAB=prom([v.C16,v.C17,v.C18]);
  const ICE=prom([v.C19,v.C20,v.C21]);
  const EQ=nv('EQ'),DIV=nv('DIV'),RES=nv('RES');
  const ISM=prom([EQ,DIV,RES]);
  const MSDA=prom([IPC,IAE,IIM,IEB,IAB,ICE]);
  return {v,IPC,IAE,IIM,IEB,IAB,ICE,EQ,DIV,RES,ISM,MSDA};
}

// Escala tipo semáforo
function colorSemaforo(val){
  if(val==null) return '#555';
  if(val>=80) return '#2e7d32';   // muy alto · verde fuerte
  if(val>=70) return '#66bb6a';   // alto · verde
  if(val>=60) return '#fdd835';   // medio · amarillo
  if(val>=50) return '#fb8c00';   // bajo · naranja
  return '#c62828';               // muy bajo · rojo
}
function nivel(val){
  if(val==null) return '—';
  if(val>=80) return 'Muy Alto';
  if(val>=70) return 'Alto';
  if(val>=60) return 'Medio';
  if(val>=50) return 'Bajo';
  return 'Muy Bajo';
}
function descISM(val){
  if(val==null) return '';
  if(val>=80) return 'Espacios con alta equidad de acceso, gran diversidad de actores y fuerte resonancia comunitaria. Generan cohesión social y apropiación colectiva.';
  if(val>=70) return 'Espacios con buen acceso y diversidad de usos, pero con limitaciones parciales en participación o apropiación comunitaria. Favorecen inclusión, aunque de manera desigual.';
  if(val>=60) return 'Espacios socialmente funcionales pero no integradores. La diversidad o la resonancia quedan restringidas a ciertos grupos; equidad parcial.';
  if(val>=50) return 'Espacios con acceso restringido y baja diversidad. La resonancia comunitaria es débil; predominan usos excluyentes o elitistas.';
  return 'Espacios excluyentes y socialmente pobres: equidad mínima, sin diversidad de actores, sin memoria ni apropiación comunitaria. Generan segregación social.';
}
function descEVC(val){
  if(val==null) return '';
  if(val>=80) return 'Espacios legibles, inmersivos, biofílicos, biomiméticos y memorables; máxima cognición adaptativa con el sujeto. Integración armónica de los tres espacios de la TERC.';
  if(val>=70) return 'Proyectos equilibrados y efectivos en su organización espacial, con limitaciones parciales en alguna dimensión.';
  if(val>=60) return 'Proyectos funcionales con desbalances internos; algún índice (IPC, IAE, IIM, IEB, IAB o ICE) se desploma y arrastra el promedio.';
  return 'Resonancia cognitiva deficiente; predominio de lo utilitario sobre lo simbiótico. El espacio funciona pero no genera memorabilidad significativa.';
}

function drawRadar(){
  const cv=g('radar'),ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height,cx=W/2,cy=H/2,R=Math.min(W,H)*0.38;
  ctx.clearRect(0,0,W,H);
  const ring=t=>R*(t/100);
  ctx.strokeStyle="#e1e1e1";ctx.lineWidth=1;
  for(let t=0;t<=100;t+=10){ctx.beginPath();ctx.arc(cx,cy,ring(t),0,2*Math.PI);ctx.stroke()}
  const axes=["IPC","IAE","IIM","IEB","IAB","ICE"];
  const labels=[
    "Índice de\nPercepción\nCognitiva (IPC)",
    "Índice de\nAdaptabilidad\nEspacial (IAE)",
    "Índice de\nInmersión y\nMemoria (IIM)",
    "Índice de\nEficiencia\nBioestructural (IEB)",
    "Índice de\nAdaptabilidad\nBiofísica (IAB)",
    "Índice de\nConectividad\nEcosistémica (ICE)"
  ];
  const ang=axes.map((_,i)=>-Math.PI/2+i*(2*Math.PI/axes.length));
  ctx.setLineDash([5,5]);
  labels.forEach((lab,i)=>{
    const a=ang[i],x=cx+R*Math.cos(a),y=cy+R*Math.sin(a);
    ctx.strokeStyle="#888";ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x,y);ctx.stroke();
    const lx=cx+(R+30)*Math.cos(a),ly=cy+(R+30)*Math.sin(a);
    ctx.fillStyle="#333";ctx.font="12px system-ui,sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
    lab.split("\n").forEach((s,k)=>ctx.fillText(s,lx,ly+(k-1)*14));
  });
  ctx.setLineDash([]);
  const p=calcAll();
  const poly=axes.map((k,i)=>{
    const v=Math.max(0,Math.min(100,p[k]||0));
    return [cx+ring(v)*Math.cos(ang[i]),cy+ring(v)*Math.sin(ang[i])];
  });
  ctx.beginPath();poly.forEach((pt,i)=>i?ctx.lineTo(pt[0],pt[1]):ctx.moveTo(pt[0],pt[1]));ctx.closePath();
  ctx.fillStyle="rgba(0,0,0,.06)";ctx.strokeStyle="#111";ctx.lineWidth=2;ctx.fill();ctx.stroke();
  ctx.fillStyle="#111";ctx.font="11px system-ui,sans-serif";ctx.textAlign="center";
  poly.forEach((pt,i)=>{ctx.beginPath();ctx.arc(pt[0],pt[1],3,0,2*Math.PI);ctx.fill();const val=Math.round(p[axes[i]]||0);ctx.fillText(String(val),pt[0],pt[1]-12)});
  // ISM triangle
  const a3=[-Math.PI/2,-Math.PI/2+2*Math.PI/3,-Math.PI/2+4*Math.PI/3];
  const vals=[p.EQ||0,p.DIV||0,p.RES||0].map(v=>Math.max(0,Math.min(100,v)));
  const tri=a3.map((a,i)=>[cx+ring(vals[i])*Math.cos(a),cy+ring(vals[i])*Math.sin(a)]);
  ctx.beginPath();tri.forEach((pt,i)=>i?ctx.lineTo(pt[0],pt[1]):ctx.moveTo(pt[0],pt[1]));ctx.closePath();
  ctx.fillStyle="rgba(200,0,0,.12)";ctx.strokeStyle="rgba(200,0,0,.9)";ctx.lineWidth=2;ctx.fill();ctx.stroke();
  const labs3=["Equidad de acceso","Diversidad de usos y actores","Resonancia comunitaria"];
  ctx.fillStyle="#b00000";ctx.font="12px system-ui,sans-serif";
  tri.forEach((pt,i)=>{ctx.beginPath();ctx.arc(pt[0],pt[1],3,0,2*Math.PI);ctx.fill();ctx.fillText(`${labs3[i]} (${Math.round(vals[i])})`,pt[0],pt[1]-12)});
  // título
  ctx.fillStyle="#111";ctx.font="16px system-ui,sans-serif";ctx.textAlign="center";ctx.fillText(`MSDA/TERC + ISM — ${g('projName').value||'Proyecto sin nombre'}`,cx,28);
}

function drawBars(){
  const cv=g('bars'),ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;ctx.clearRect(0,0,W,H);
  const p=calcAll(), vals=p.v;
  const labels=[
    "C1 Carga Informativa del Espacio","C2 Diversidad Perceptual","C3 Conectividad Sensorial","C4 Accesibilidad Cognitiva",
    "C5 Plasticidad Ambiental","C6 Complejidad Estructural vs. Legibilidad","C7 Efecto de Resonancia Cognitiva","C8 Interacción Natural o Biofílica",
    "C9 Engagement Espacial","C10 Fluidez en la Navegación Espacial","C11 Efecto Memorístico","C12 Resonancia Emocional",
    "C13 Eficiencia Geométrica","C14 Optimización Estructural","C15 Uso de Biomateriales",
    "C16 Eficiencia Energética","C17 Adaptabilidad Térmica","C18 Captación y Uso de Agua",
    "C19 Integración con la Naturaleza","C20 Ciclo de Materiales","C21 Bienestar Biofílico"
  ];
  const data=labels.map((lab,i)=>({lab,val:vals['C'+(i+1)]||0}));
  const padL=520,padR=60,padT=40,padB=40;
  const innerW=W-padL-padR, innerH=H-padT-padB;
  const rowH=innerH/labels.length;
  ctx.fillStyle="#111";ctx.font="20px system-ui,sans-serif";ctx.textAlign="center";ctx.fillText("CALIFICACIÓN POR CARACTERÍSTICA",W/2,22);
  ctx.textAlign="right";ctx.font="13px system-ui,sans-serif";
  data.forEach((d,i)=>{
    const y=padT+i*rowH+rowH*0.5;
    ctx.fillStyle="#111";ctx.fillText(d.lab,padL-12,y);
    ctx.strokeStyle="#eee";ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(W-padR,y);ctx.stroke();
    const w=innerW*(Math.max(0,Math.min(100,d.val))/100);
    ctx.fillStyle=colorSemaforo(d.val);
    ctx.fillRect(padL,y-6,w,12);
    ctx.fillStyle="#0a0a0a";ctx.font="12px system-ui,sans-serif";ctx.textAlign="right";ctx.fillText(`${Math.round(d.val)}%`,padL+w+28,y+4);
  });
  ctx.textAlign="center";ctx.fillStyle="#666";
  for(let t=0;t<=100;t+=10){const x=padL+innerW*(t/100);ctx.fillText(t+"%",x,H-10);}
}

function updateResultados(){
  const p=calcAll();
  const fmt = x=> x==null ? '—' : Number(x).toFixed(2);
  g('placaEVC').textContent = fmt(p.MSDA);
  g('placaISM').textContent = fmt(p.ISM);
  g('placaEVC').style.color = colorSemaforo(p.MSDA);
  g('placaISM').style.color = colorSemaforo(p.ISM);

  const resumen = [
    'RESULTADOS DE MEDICIÓN COGNITIVA: ',
    `EVC-TERC:    ${fmt(p.MSDA)} (${nivel(p.MSDA)})              ISM: ${fmt(p.ISM)} (${nivel(p.ISM)})`,
    '',
    '1) Índices de Teoría del Espacio Receptor Cognitivo TERC (promedios):',
    `IPC (Índice de Percepción Cognitiva) = ${fmt(p.IPC)}`,
    `IAE (Índice de Adaptabilidad Espacial) = ${fmt(p.IAE)}`,
    `IIM (Índice de Inmersión y Memoria) = ${fmt(p.IIM)}`,
    `IEB (Índice de Eficiencia Bioestructural) = ${fmt(p.IEB)}`,
    `IAB (Índice de Adaptabilidad Biofísica) = ${fmt(p.IAB)}`,
    `ICE (Índice de Conectividad Ecosistémica) = ${fmt(p.ICE)}`,
    `MSDA (promedio de 6 índices) = ${fmt(p.MSDA)}  →  EVC-TERC ${nivel(p.MSDA)}`,
    '',
    `2) Índice Social Medible ISM (Equidad + Diversidad + Resonancia) = ${fmt(p.ISM)} → ${nivel(p.ISM)}`,
    `   Justificación (según tabla ISM): ${descISM(p.ISM)}`,
    `   Justificación (según tabla EVC–TERC): ${descEVC(p.MSDA)}`
  ].join('\n');
  g('resultadoTxt').textContent = resumen;
}

function drawAll(){ drawRadar(); drawBars(); updateResultados(); }

document.getElementById('goCalc').addEventListener('click', drawAll);

// DEMO
document.getElementById('demoBtn').addEventListener('click', ()=>{
  const demo = {Proyecto:'DEMO', C1:90,C2:85,C3:80,C4:60, C5:70,C6:75,C7:85,C8:95, C9:80,C10:70,C11:90,C12:85, C13:80,C14:75,C15:65, C16:60,C17:70,C18:80, C19:95,C20:50,C21:90, Equidad:78, Diversidad:74, Resonancia:76};
  g('projName').value = demo.Proyecto;
  for(let i=1;i<=21;i++) g('C'+i).value = demo['C'+i];
  g('EQ').value=demo.Equidad; g('DIV').value=demo.Diversidad; g('RES').value=demo.Resonancia;
  drawAll();
});

// CSV
document.getElementById('csvBtn').addEventListener('click', ()=> g('csvFile').click());
document.getElementById('csvFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f){return}
  g('csvStatus').textContent = 'Leyendo CSV local...';
  const txt = await f.text();
  const lines = txt.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(s=>s.trim());
  const idx = (name)=> headers.indexOf(name);
  const row = lines[1] ? lines[1].split(',') : null;
  if(!row){ g('csvStatus').textContent='CSV vacío.'; return; }
  const get=(name)=>{ const i=idx(name); return i>=0? row[i].trim():''; };
  g('projName').value = get('Proyecto') || 'CSV';
  for(let i=1;i<=21;i++){ g('C'+i).value = get('C'+i) || ''; }
  g('EQ').value = get('Equidad') || '';
  g('DIV').value = get('Diversidad') || '';
  g('RES').value = get('Resonancia') || '';
  g('csvStatus').textContent = 'CSV cargado.';
  drawAll();
});

// Exportar JPEG en alta resolución
document.getElementById('goJPG').addEventListener('click', ()=>{
  const radar = g('radar'), bars = g('bars');
  const out = document.createElement('canvas');
  const marginTop = 40, between = 120, bottom = 60;
  const width = Math.max(radar.width, bars.width);
  const height = marginTop + radar.height + between + bars.height + bottom;
  out.width = width; out.height = height;
  const ctx = out.getContext('2d');
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,width,height);
  // título
  ctx.fillStyle='#111'; ctx.font='22px system-ui,sans-serif'; ctx.textAlign='center';
  ctx.fillText('MSDA/TERC + ISM — ' + (g('projName').value||'Proyecto'), width/2, 28);
  // radar
  ctx.drawImage(radar, (width - radar.width)/2, marginTop);
  // placas
  ctx.fillStyle='#111'; ctx.font='16px system-ui,sans-serif'; ctx.textAlign='left';
  const yPlaca = marginTop + radar.height + 40;
  ctx.fillText('EVC–TERC:', 40, yPlaca);
  ctx.fillText('ISM:', 260, yPlaca);
  ctx.fillStyle = colorSemaforo(parseFloat(g('placaEVC').textContent));
  ctx.font='bold 40px system-ui,sans-serif';
  ctx.fillText(g('placaEVC').textContent || '—', 140, yPlaca+4);
  ctx.fillStyle = colorSemaforo(parseFloat(g('placaISM').textContent));
  ctx.fillText(g('placaISM').textContent || '—', 320, yPlaca+4);
  // barras
  ctx.drawImage(bars, (width - bars.width)/2, marginTop + radar.height + between);
  // descarga
  const link = document.createElement('a');
  link.download = (g('projName').value || 'msda_ism') + '_v9.jpg';
  link.href = out.toDataURL('image/jpeg', 0.96);
  link.click();
});

drawAll();
</script>
</body>
</html>
