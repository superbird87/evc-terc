<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TERC·ISM — Demo Rediseñada</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
header h1{font-size:24px;margin-bottom:8px}
.buttons-bar{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
.statusbar{margin-top:8px;font-size:12px;color:var(--muted)}
#tableContainer{max-height:400px;overflow:auto;margin-top:16px}
</style>
</head>
<body>
<header>
  <h1>TERC·ISM — Generador de Narrativas</h1>
  <div class="buttons-bar">
    <label class="badge">Cargar CSV local<input type="file" id="fileInput" accept=".csv" style="display:none"></label>
    <button id="useDemo">Usar demo de 5 casos</button>
    <button id="downloadMD">Descargar Narrativa (MD)</button>
    <button id="downloadJSONL">Descargar Narrativa (JSONL)</button>
  </div>
  <div class="statusbar" id="status">Listo</div>
</header>

<main>
  <div class="grid">
    <section>
      <h2>Tabla de proyectos</h2>
      <div id="tableContainer">
        <div id="table"></div>
      </div>
    </section>
    <aside>
      <h2>Narrativa</h2>
      <select id="rowSelect"></select>
      <textarea id="output" readonly></textarea>
    </aside>
  </div>
</main>
<footer>GitHub Pages listo — ahora con carga local y exportación.</footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const statusEl = document.getElementById('status');
const outEl = document.getElementById('output');
const rowSel = document.getElementById('rowSelect');
const tableHost = document.getElementById('table');
const fileInput = document.getElementById('fileInput');

const CSV_URL = './data/demo_proyectos_TERC_ISM.csv';
const PLANTILLA_URL = './data/plantilla_semantica_v1.json';
const PATRONES_URL = './data/patrones_semanticos.json';

let DATA=[], PLANTILLA=null, PATRONES=null;

async function loadJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('No se pudo cargar '+url);
  return await r.json();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function etiquetaYadjetivos(valor, defs){
  const d = defs.find(x => valor>=x.min && valor<=x.max);
  const adj1 = pick(d.adjetivos);
  const adj2 = pick(d.adjetivos.filter(a=>a!==adj1));
  return {etiqueta:d.etiqueta, adj1, adj2};
}
function renderTabla(rows){
  if(!rows.length){ tableHost.textContent='Sin datos'; return; }
  const cols = Object.keys(rows[0]);
  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const body = rows.map((r,i)=>'<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>').join('');
  tableHost.innerHTML = '<table>'+thead+'<tbody>'+body+'</tbody></table>';
}
function evalDictamen(reglas, row){
  for(const r of reglas){
    try{
      const expr = r.si.replace(/terc/g, row.terc).replace(/ism/g, row.ism);
      if(Function('return ('+expr+')')()) return r.texto;
    }catch(e){}
  }
  return 's/i';
}
function compilar(row){
  const t = etiquetaYadjetivos(Number(row.terc), PATRONES.terc);
  const i = etiquetaYadjetivos(Number(row.ism), PATRONES.ism);
  const frase_terc = PATRONES.plantillasAux.frase_terc[t.etiqueta]
                      .replace('{adj1}', t.adj1).replace('{adj2}', t.adj2);
  const frase_ism = PATRONES.plantillasAux.frase_ism[i.etiqueta]
                      .replace('{adj1}', i.adj1).replace('{adj2}', i.adj2);
  const dictamen = evalDictamen(PLANTILLA.dictamen_reglas, row);
  let txt = PLANTILLA.prompt;
  for (const k of Object.keys(row)){
    txt = txt.replaceAll('{{'+k+'}}', row[k]);
  }
  txt = txt.replaceAll('{{frase_terc}}', frase_terc)
           .replaceAll('{{frase_ism}}', frase_ism)
           .replaceAll('{{dictamen}}', dictamen);
  return txt;
}
function actualizarSalida(index){
  const r = DATA[index];
  outEl.value = compilar(r);
}
function poblarSelector(rows){
  rowSel.innerHTML = rows.map((r,idx)=>`<option value="${idx}">${idx+1}. ${r.proyecto}</option>`).join('');
  rowSel.addEventListener('change', e=> actualizarSalida(e.target.value));
  actualizarSalida(0);
}

// Exportación
document.getElementById('downloadMD').addEventListener('click', ()=>{
  let md='';
  DATA.forEach(r=>{
    md+=`## ${r.proyecto}\n\n${compilar(r)}\n\n`;
  });
  descargar(md,'narrativa.md');
});
document.getElementById('downloadJSONL').addEventListener('click', ()=>{
  let lines=DATA.map(r=>JSON.stringify({proyecto:r.proyecto,narrativa:compilar(r)}));
  descargar(lines.join('\\n'),'narrativa.jsonl');
});
function descargar(text, filename){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
}

// Carga CSV local
fileInput.addEventListener('change', ()=>{
  const file = fileInput.files?.[0];
  if(!file)return;
  statusEl.textContent=`Leyendo CSV local ${file.name}…`;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV local: '+err.message;}
  });
});

// Botón usar demo
document.getElementById('useDemo').addEventListener('click', ()=>{
  statusEl.textContent='Cargando demo de 5 casos…';
  Papa.parse(CSV_URL,{
    download:true,header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV demo: '+err.message;}
  });
});

function postLoadCSV(rows){
  DATA=rows.map(r=>({...r,terc:Number(r.terc),ism:Number(r.ism)}));
  renderTabla(DATA);
  poblarSelector(DATA);
  statusEl.textContent=`Listo · filas: ${DATA.length}`;
}

async function boot(){
  try{
    statusEl.textContent='Cargando JSON…';
    [PLANTILLA,PATRONES] = await Promise.all([loadJSON(PLANTILLA_URL), loadJSON(PATRONES_URL)]);
    // carga demo inicial
    document.getElementById('useDemo').click();
  }catch(e){
    statusEl.textContent='Error JSON: '+e.message;
  }
}
boot();
</script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TERC·ISM — Demo Rediseñada</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
header h1{font-size:24px;margin-bottom:8px}
.buttons-bar{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
.statusbar{margin-top:8px;font-size:12px;color:var(--muted)}
#tableContainer{max-height:400px;overflow:auto;margin-top:16px}
</style>
</head>
<body>
<header>
  <h1>TERC·ISM — Generador de Narrativas</h1>
  <div class="buttons-bar">
    <label class="badge">Cargar CSV local<input type="file" id="fileInput" accept=".csv" style="display:none"></label>
    <button id="useDemo">Usar demo de 5 casos</button>
    <button id="downloadMD">Descargar Narrativa (MD)</button>
    <button id="downloadJSONL">Descargar Narrativa (JSONL)</button>
  </div>
  <div class="statusbar" id="status">Listo</div>
</header>

<main>
  <div class="grid">
    <section>
      <h2>Tabla de proyectos</h2>
      <div id="tableContainer">
        <div id="table"></div>
      </div>
    </section>
    <aside>
      <h2>Narrativa</h2>
      <select id="rowSelect"></select>
      <textarea id="output" readonly></textarea>
    </aside>
  </div>
</main>
<footer>GitHub Pages listo — ahora con carga local y exportación.</footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const statusEl = document.getElementById('status');
const outEl = document.getElementById('output');
const rowSel = document.getElementById('rowSelect');
const tableHost = document.getElementById('table');
const fileInput = document.getElementById('fileInput');

const CSV_URL = './data/demo_proyectos_TERC_ISM.csv';
const PLANTILLA_URL = './data/plantilla_semantica_v1.json';
const PATRONES_URL = './data/patrones_semanticos.json';

let DATA=[], PLANTILLA=null, PATRONES=null;

async function loadJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('No se pudo cargar '+url);
  return await r.json();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function etiquetaYadjetivos(valor, defs){
  const d = defs.find(x => valor>=x.min && valor<=x.max);
  const adj1 = pick(d.adjetivos);
  const adj2 = pick(d.adjetivos.filter(a=>a!==adj1));
  return {etiqueta:d.etiqueta, adj1, adj2};
}
function renderTabla(rows){
  if(!rows.length){ tableHost.textContent='Sin datos'; return; }
  const cols = Object.keys(rows[0]);
  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const body = rows.map((r,i)=>'<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>').join('');
  tableHost.innerHTML = '<table>'+thead+'<tbody>'+body+'</tbody></table>';
}
function evalDictamen(reglas, row){
  for(const r of reglas){
    try{
      const expr = r.si.replace(/terc/g, row.terc).replace(/ism/g, row.ism);
      if(Function('return ('+expr+')')()) return r.texto;
    }catch(e){}
  }
  return 's/i';
}
function compilar(row){
  const t = etiquetaYadjetivos(Number(row.terc), PATRONES.terc);
  const i = etiquetaYadjetivos(Number(row.ism), PATRONES.ism);
  const frase_terc = PATRONES.plantillasAux.frase_terc[t.etiqueta]
                      .replace('{adj1}', t.adj1).replace('{adj2}', t.adj2);
  const frase_ism = PATRONES.plantillasAux.frase_ism[i.etiqueta]
                      .replace('{adj1}', i.adj1).replace('{adj2}', i.adj2);
  const dictamen = evalDictamen(PLANTILLA.dictamen_reglas, row);
  let txt = PLANTILLA.prompt;
  for (const k of Object.keys(row)){
    txt = txt.replaceAll('{{'+k+'}}', row[k]);
  }
  txt = txt.replaceAll('{{frase_terc}}', frase_terc)
           .replaceAll('{{frase_ism}}', frase_ism)
           .replaceAll('{{dictamen}}', dictamen);
  return txt;
}
function actualizarSalida(index){
  const r = DATA[index];
  outEl.value = compilar(r);
}
function poblarSelector(rows){
  rowSel.innerHTML = rows.map((r,idx)=>`<option value="${idx}">${idx+1}. ${r.proyecto}</option>`).join('');
  rowSel.addEventListener('change', e=> actualizarSalida(e.target.value));
  actualizarSalida(0);
}

// Exportación
document.getElementById('downloadMD').addEventListener('click', ()=>{
  let md='';
  DATA.forEach(r=>{
    md+=`## ${r.proyecto}\n\n${compilar(r)}\n\n`;
  });
  descargar(md,'narrativa.md');
});
document.getElementById('downloadJSONL').addEventListener('click', ()=>{
  let lines=DATA.map(r=>JSON.stringify({proyecto:r.proyecto,narrativa:compilar(r)}));
  descargar(lines.join('\\n'),'narrativa.jsonl');
});
function descargar(text, filename){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
}

// Carga CSV local
fileInput.addEventListener('change', ()=>{
  const file = fileInput.files?.[0];
  if(!file)return;
  statusEl.textContent=`Leyendo CSV local ${file.name}…`;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV local: '+err.message;}
  });
});

// Botón usar demo
document.getElementById('useDemo').addEventListener('click', ()=>{
  statusEl.textContent='Cargando demo de 5 casos…';
  Papa.parse(CSV_URL,{
    download:true,header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV demo: '+err.message;}
  });
});

function postLoadCSV(rows){
  DATA=rows.map(r=>({...r,terc:Number(r.terc),ism:Number(r.ism)}));
  renderTabla(DATA);
  poblarSelector(DATA);
  statusEl.textContent=`Listo · filas: ${DATA.length}`;
}

async function boot(){
  try{
    statusEl.textContent='Cargando JSON…';
    [PLANTILLA,PATRONES] = await Promise.all([loadJSON(PLANTILLA_URL), loadJSON(PATRONES_URL)]);
    // carga demo inicial
    document.getElementById('useDemo').click();
  }catch(e){
    statusEl.textContent='Error JSON: '+e.message;
  }
}
boot();
</script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TERC·ISM — Demo Rediseñada</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
header h1{font-size:24px;margin-bottom:8px}
.buttons-bar{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
.statusbar{margin-top:8px;font-size:12px;color:var(--muted)}
#tableContainer{max-height:400px;overflow:auto;margin-top:16px}
</style>
</head>
<body>
<header>
  <h1>TERC·ISM — Generador de Narrativas</h1>
  <div class="buttons-bar">
    <label class="badge">Cargar CSV local<input type="file" id="fileInput" accept=".csv" style="display:none"></label>
    <button id="useDemo">Usar demo de 5 casos</button>
    <button id="downloadMD">Descargar Narrativa (MD)</button>
    <button id="downloadJSONL">Descargar Narrativa (JSONL)</button>
  </div>
  <div class="statusbar" id="status">Listo</div>
</header>

<main>
  <div class="grid">
    <section>
      <h2>Tabla de proyectos</h2>
      <div id="tableContainer">
        <div id="table"></div>
      </div>
    </section>
    <aside>
      <h2>Narrativa</h2>
      <select id="rowSelect"></select>
      <textarea id="output" readonly></textarea>
    </aside>
  </div>
</main>
<footer>GitHub Pages listo — ahora con carga local y exportación.</footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const statusEl = document.getElementById('status');
const outEl = document.getElementById('output');
const rowSel = document.getElementById('rowSelect');
const tableHost = document.getElementById('table');
const fileInput = document.getElementById('fileInput');

const CSV_URL = './data/demo_proyectos_TERC_ISM.csv';
const PLANTILLA_URL = './data/plantilla_semantica_v1.json';
const PATRONES_URL = './data/patrones_semanticos.json';

let DATA=[], PLANTILLA=null, PATRONES=null;

async function loadJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('No se pudo cargar '+url);
  return await r.json();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function etiquetaYadjetivos(valor, defs){
  const d = defs.find(x => valor>=x.min && valor<=x.max);
  const adj1 = pick(d.adjetivos);
  const adj2 = pick(d.adjetivos.filter(a=>a!==adj1));
  return {etiqueta:d.etiqueta, adj1, adj2};
}
function renderTabla(rows){
  if(!rows.length){ tableHost.textContent='Sin datos'; return; }
  const cols = Object.keys(rows[0]);
  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const body = rows.map((r,i)=>'<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>').join('');
  tableHost.innerHTML = '<table>'+thead+'<tbody>'+body+'</tbody></table>';
}
function evalDictamen(reglas, row){
  for(const r of reglas){
    try{
      const expr = r.si.replace(/terc/g, row.terc).replace(/ism/g, row.ism);
      if(Function('return ('+expr+')')()) return r.texto;
    }catch(e){}
  }
  return 's/i';
}
function compilar(row){
  const t = etiquetaYadjetivos(Number(row.terc), PATRONES.terc);
  const i = etiquetaYadjetivos(Number(row.ism), PATRONES.ism);
  const frase_terc = PATRONES.plantillasAux.frase_terc[t.etiqueta]
                      .replace('{adj1}', t.adj1).replace('{adj2}', t.adj2);
  const frase_ism = PATRONES.plantillasAux.frase_ism[i.etiqueta]
                      .replace('{adj1}', i.adj1).replace('{adj2}', i.adj2);
  const dictamen = evalDictamen(PLANTILLA.dictamen_reglas, row);
  let txt = PLANTILLA.prompt;
  for (const k of Object.keys(row)){
    txt = txt.replaceAll('{{'+k+'}}', row[k]);
  }
  txt = txt.replaceAll('{{frase_terc}}', frase_terc)
           .replaceAll('{{frase_ism}}', frase_ism)
           .replaceAll('{{dictamen}}', dictamen);
  return txt;
}
function actualizarSalida(index){
  const r = DATA[index];
  outEl.value = compilar(r);
}
function poblarSelector(rows){
  rowSel.innerHTML = rows.map((r,idx)=>`<option value="${idx}">${idx+1}. ${r.proyecto}</option>`).join('');
  rowSel.addEventListener('change', e=> actualizarSalida(e.target.value));
  actualizarSalida(0);
}

// Exportación
document.getElementById('downloadMD').addEventListener('click', ()=>{
  let md='';
  DATA.forEach(r=>{
    md+=`## ${r.proyecto}\n\n${compilar(r)}\n\n`;
  });
  descargar(md,'narrativa.md');
});
document.getElementById('downloadJSONL').addEventListener('click', ()=>{
  let lines=DATA.map(r=>JSON.stringify({proyecto:r.proyecto,narrativa:compilar(r)}));
  descargar(lines.join('\\n'),'narrativa.jsonl');
});
function descargar(text, filename){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
}

// Carga CSV local
fileInput.addEventListener('change', ()=>{
  const file = fileInput.files?.[0];
  if(!file)return;
  statusEl.textContent=`Leyendo CSV local ${file.name}…`;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV local: '+err.message;}
  });
});

// Botón usar demo
document.getElementById('useDemo').addEventListener('click', ()=>{
  statusEl.textContent='Cargando demo de 5 casos…';
  Papa.parse(CSV_URL,{
    download:true,header:true,skipEmptyLines:true,worker:true,
    complete:(res)=>{postLoadCSV(res.data)},
    error:(err)=>{statusEl.textContent='Error CSV demo: '+err.message;}
  });
});

function postLoadCSV(rows){
  DATA=rows.map(r=>({...r,terc:Number(r.terc),ism:Number(r.ism)}));
  renderTabla(DATA);
  poblarSelector(DATA);
  statusEl.textContent=`Listo · filas: ${DATA.length}`;
}

async function boot(){
  try{
    statusEl.textContent='Cargando JSON…';
    [PLANTILLA,PATRONES] = await Promise.all([loadJSON(PLANTILLA_URL), loadJSON(PATRONES_URL)]);
    // carga demo inicial
    document.getElementById('useDemo').click();
  }catch(e){
    statusEl.textContent='Error JSON: '+e.message;
  }
}
boot();
</script>
</body>
</html>
